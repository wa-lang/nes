<!DOCTYPE html>

<title>凹语言版 - NES 模拟器</title>

<div style="text-align: center">
  <canvas id="nes" width="256" height="240" style="width:768px;height:720px;"></canvas>

  <div>小键盘方向键：方向键; 回车:start; 空格:select; Ctrl: A; Shift: B</div>
</div>

<script type="text/javascript" src="./nes.js"></script>

<script>
  let app = new WaApp();

  let key_map = new Map();

  let lastDownTarget, nesCanvas;
  let lastKeyTimeStamp;

  let btnA = false;
  let btnB = false;
  let btnSelect = false;
  let btnStart = false;
  let btnUp = false;
  let btnDown = false;
  let btnLeft = false;
  let btnRight = false;
  let btnReset = false;

  function release_key(key) {
    if (key_map.has(key)) {
      const k = key_map.get(key);
      k.pressed = false;
    }
  }

  function get_key_status(key) {
    if (key_map.has(key)) {
      const k = key_map.get(key);
      return k.pressed;
    }
    return false;
  }

  window.onload = () => { 
    nesCanvas = document.getElementById('nes'); 
    document.addEventListener('mousedown', (event) => { 
      lastDownTarget = event.target; 
      console.log(`Mousedown Event: ${event}`);
    }, false);

    document.addEventListener('keydown', (event) => {
      if (key_map.has(event.key)) {
        const k = key_map.get(event.key);
        k.pressed = true;
      }
      else {
        const k = {}
        k.pressed = true;
        key_map.set(event.key, k);
      }
    }, false);

    document.addEventListener('keyup', (event) => {
      if (key_map.has(event.key)) {
        const k = key_map.get(event.key);
        release_key(event.key)
      }
    }, false);

    app.init().then((result) => {
      app.main();

      app.NES_InitGame();

      let preTimeStamp;
      let stepAnima = function (timeStamp) {
        // 转化为秒为单位
        if(timeStamp > 0) {
          timeStamp = timeStamp/1000;
        } else {
          timeStamp = 0;
        }

        // 记录当前时间
        if (!preTimeStamp) {
          preTimeStamp = timeStamp;
        }

        // 时间间隔
        let dt = timeStamp - preTimeStamp;
        //console.log('dt: ', dt);

        if(btnReset) {
          btnReset = false;
          app.NES_Reset();
        }

        // 执行
        btnA = get_key_status('Control') && !btnA;
        btnB = get_key_status('Alt') && !btnB;
        btnSelect = get_key_status(' ');
        btnStart = get_key_status('Enter');
        btnUp = get_key_status('ArrowUp')
        btnDown = get_key_status('ArrowDown')
        btnLeft = get_key_status('ArrowLeft')
        btnRight = get_key_status('ArrowRight')

        //console.log("key: btnA, btnB, btnSelect, btnStart, btnUp, btnDown, btnLeft, btnRight")
        //console.log(`key: ${btnA}, ${btnB}, ${btnSelect}, ${btnStart}, ${btnUp}, ${btnDown}, ${btnLeft}, ${btnRight}`)
        app.NES_SetButtons1(btnA, btnB, btnSelect, btnStart, btnUp, btnDown, btnLeft, btnRight);
        app.NES_StepFrame(dt);

        preTimeStamp = timeStamp;
        window.requestAnimationFrame(stepAnima);
      }
      window.requestAnimationFrame(stepAnima);
    });
  }
</script>

