<!DOCTYPE html>

<title>凹语言版 - NES 模拟器</title>

<div style="text-align: center">
  <canvas id="nes" width="256" height="240" style="width:768px;height:720px;"></canvas>

  <div>小键盘方向键：方向键; 回车:start; 空格:select; Ctrl: A; Shift: B; R: Reset</div>

  <button id='A'>A</button>
  <button id='B'>B</button>
  <button id='Select'>Select</button>
  <button id='Start'>Start</button>
  <button id='Reset'>Reset</button>
</div>

<script type="text/javascript" src="./nes.js"></script>
<script src="./hammer.js"></script>
<script src="./my-joystick.js"></script>

<script>
  let app = new WaApp();

  let key_map = new Map();

  let lastDownTarget, nesCanvas;
  let lastKeyTimeStamp;

  let btnA = false;
  let btnB = false;
  let btnSelect = false;
  let btnStart = false;
  let btnUp = false;
  let btnDown = false;
  let btnLeft = false;
  let btnRight = false;
  let btnReset = false;

  function press_key(key) {
    if (key_map.has(key)) {
      let k = key_map.get(key);
      k.pressed = true;
    }
    else {
      const k = {}
      k.pressed = true;
      key_map.set(key, k);
    }
  }

  function release_key(key) {
    if (key_map.has(key)) {
      const k = key_map.get(key);
      k.pressed = false;
    }
  }

  function get_key_status(key) {
    if (key_map.has(key)) {
      const k = key_map.get(key);
      return k.pressed;
    }
    return false;
  }

  let jsconf = {
    frontColor: "#0680d7",
    backColor: "red",
    backR: 100,
    frontR: 40,
    distanceX: null,
    distanceY: null,
  };
  const joystick = new MyJoystick(jsconf);
  joystick.openJoystick(function (ev) {
    release_key('Up')
    release_key('Down')
    release_key('Left')
    release_key('Right')

    if (ev.direction === 'up') {
      press_key('Up');
    } else if (ev.direction === 'down') {
      press_key('Down');
    } else if (ev.direction === 'left') {
      press_key('Left');
    } else if (ev.direction === 'right') {
      press_key('Right');
    }
  });

  {
    let A = document.getElementById("A");
    A.addEventListener("touchstart", function(ev){
      press_key('A')
    }, false);
    A.addEventListener("touchend", function(ev){
      release_key('A')
    }, false);
  }
  {
    let B = document.getElementById("B");
    B.addEventListener("touchstart", function(ev){
      press_key('B')
    }, false);
    B.addEventListener("touchend", function(ev){
      release_key('B')
    }, false);
  }
  {
    let Select = document.getElementById("Select");
    Select.addEventListener("touchstart", function(ev){
      press_key('Select')
    }, false);
    Select.addEventListener("touchend", function(ev){
      release_key('Select')
    }, false);
  }
  {
    let Start = document.getElementById("Start");
    Start.addEventListener("touchstart", function(ev){
      press_key('Start')
    }, false);
    Start.addEventListener("touchend", function(ev){
      release_key('Start')
    }, false);
  }
  {
    let Reset = document.getElementById("Reset");
    Reset.addEventListener("touchstart", function(ev){
      press_key('Reset')
    }, false);
    Reset.addEventListener("touchend", function(ev){
      release_key('Reset')
    }, false);
  }

  window.onload = () => {
    document.addEventListener('keydown', (event) => {
      switch (event.key) {
        case 'Control':
          press_key('A');
          break;

        case 'Shift':
          press_key('B');
          break;

        case ' ':
          press_key('Select')
          break;

        case 'Enter':
          press_key('Start')
          break;

        case 'ArrowUp':
          press_key('Up')
          break;

        case 'ArrowDown':
          press_key('Down')
          break;

        case 'ArrowLeft':
          press_key('Left')
          break;

        case 'ArrowRight':
          press_key('Right')
          break;

        case 'r':
          press_key('Reset')
          break;
      }
    }, false);

    document.addEventListener('keyup', (event) => {
      switch (event.key) {
        case 'Control':
          release_key('A');
          break;

        case 'Shift':
          release_key('B');
          break;

        case ' ':
          release_key('Select');
          break;

        case 'Enter':
          release_key('Start')
          break;

        case 'ArrowUp':
          release_key('Up')
          break;

        case 'ArrowDown':
          release_key('Down')
          break;

        case 'ArrowLeft':
          release_key('Left')
          break;

        case 'ArrowRight':
          release_key('Right')
          break;

        case 'r':
          release_key('Reset')
          break;
      }
    }, false);

    app.init().then((result) => {
      app.main();

      app.NES_InitGame();

      let preTimeStamp;
      let stepAnima = function (timeStamp) {
        // 执行
        btnA = get_key_status('A') && !btnA;
        btnB = get_key_status('B') && !btnB;
        btnSelect = get_key_status('Select');
        btnStart = get_key_status('Start');
        btnUp = get_key_status('Up')
        btnDown = get_key_status('Down')
        btnLeft = get_key_status('Left')
        btnRight = get_key_status('Right')
        btnReset = get_key_status('Reset')

        if (btnReset) {
          btnReset = false;
          app.NES_Reset();
        }

        app.NES_SetButtons1(btnA, btnB, btnSelect, btnStart, btnUp, btnDown, btnLeft, btnRight);
        app.NES_StepFrame();

        preTimeStamp = timeStamp;
        window.requestAnimationFrame(stepAnima);
      }
      window.requestAnimationFrame(stepAnima);
    });
  }
</script>